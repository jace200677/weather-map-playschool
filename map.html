<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Global Custom Weather Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  #map { height: 600px; width: 100%; }
  #controls { padding: 5px; }
</style>
</head>
<body>

<h2>Global Custom Weather Forecast</h2>
<div id="map"></div>
<div id="controls">
  <button onclick="prevStep()">⏮ Previous</button>
  <button onclick="nextStep()">Next ⏭</button>
  <span id="timeLabel">Time: </span>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/chroma-js@2.1.0/chroma.min.js"></script>

<script>
// ---------------- INIT MAP ----------------
const map = L.map('map').setView([0,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

// ---------------- LOAD JSON ----------------
let forecastData = [];
fetch('forecast.json')   // Python-generated JSON file
  .then(resp => resp.json())
  .then(data => {
    forecastData = data;
    drawForecast(currentStep);
  });

// ---------------- VARIABLES ----------------
let currentStep = 0;
let layersGroup = L.layerGroup().addTo(map);

// ---------------- DRAW FORECAST ----------------
function drawForecast(stepIndex){
  if(forecastData.length === 0) return;
  layersGroup.clearLayers();
  const data = forecastData[stepIndex];
  data.forEach(d=>{
    // Temp 2m: color circles
    const tempColor = chroma.scale(['blue','green','yellow','red']).domain([-30,50])(d.temp).hex();
    L.circleMarker([d.lat,d.lon],{
      radius: 5,
      color: tempColor,
      fillColor: tempColor,
      fillOpacity: 0.6
    }).addTo(layersGroup);

    // Precip 3h: blue overlay
    if(d.precip3h>0){
      const precipColor = chroma.scale(['#00f','#0044ff']).domain([0,10])(d.precip3h).hex();
      L.circleMarker([d.lat,d.lon],{
        radius: 3,
        color: precipColor,
        fillColor: precipColor,
        fillOpacity: 0.5
      }).addTo(layersGroup);
    }

    // Wind 10m: arrows (random angle if not in JSON)
    const arrowLength = d.wind10;
    const angle = d.wind_dir || Math.random()*360; // optional wind_dir field
    const rad = angle * Math.PI / 180;
    const dx = arrowLength * Math.cos(rad);
    const dy = arrowLength * Math.sin(rad);
    L.polyline([
      [d.lat,d.lon],
      [d.lat+dy*0.05, d.lon+dx*0.05]
    ], {color:'black', weight:1}).addTo(layersGroup);

    // Gust 1h: red dots for strong gusts
    if(d.gust1h>15){
      L.circleMarker([d.lat,d.lon],{
        radius:2,
        color:'red',
        fillColor:'red',
        fillOpacity:0.7
      }).addTo(layersGroup);
    }
  });
  document.getElementById('timeLabel').innerText = "Time: " + data[0].time;
}

// ---------------- CONTROLS ----------------
function nextStep(){
  if(forecastData.length===0) return;
  currentStep = (currentStep+1)%forecastData.length;
  drawForecast(currentStep);
}
function prevStep(){
  if(forecastData.length===0) return;
  currentStep = (currentStep-1+forecastData.length)%forecastData.length;
  drawForecast(currentStep);
}

// ---------------- AUTO PLAY ----------------
setInterval(nextStep, 1000);
</script>

</body>
</html>
