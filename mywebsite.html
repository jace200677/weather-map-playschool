<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Northwoods Playschool ‚Äì Weather Score & YouTube Stream</title>
<style>
:root {
  --green: #1f4d2b;
  --light: #f6f1e6;
  --accent: #f5c542;
  --orange: #f59e0b;
  --danger: #b91c1c;
  --brown: #7c2d12;
}
body { margin:0; font-family:system-ui,sans-serif; background:var(--light); color:#2a2a2a; line-height:1.6; }
header{text-align:center;padding:3rem 1rem 2rem;}
header img{max-width:360px;width:100%;}
nav{background:var(--green);padding:0.75rem;text-align:center;}
nav a{color:#fff;text-decoration:none;margin:0 1rem;font-weight:600;}
section{max-width:900px;margin:auto;padding:3rem 1.25rem;}
h2{color:var(--green);margin-top:0;}
.intensity{display:flex;align-items:center;justify-content:space-between;gap:1rem;background:#fff;padding:1.5rem;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,0.15);margin-bottom:1.5rem;}
.score{font-size:2.5rem;font-weight:800;color:var(--green);}
.score.high{color:var(--danger);}
.level{font-weight:700;padding:0.4rem 0.75rem;border-radius:999px;background:var(--accent);}
#advisory{display:none;padding:1rem;margin-bottom:0.75rem;border-radius:16px;background:#danger;color:#fff;font-weight:700;text-align:center;}
#activeLocation{display:none;margin-bottom:1.5rem;padding:0.75rem 1rem;border-radius:12px;background:#fff3cd;font-weight:700;color:#92400e;text-align:center;}
#alerts{margin-top:1rem;background:#fff;padding:1rem;border-radius:16px;box-shadow:0 5px 15px rgba(0,0,0,0.1);}
#youtubeChance{margin-top:1rem;background:#fff;padding:1rem;border-radius:16px;box-shadow:0 5px 15px rgba(0,0,0,0.1);font-weight:700;font-size:1.1rem;text-align:center;}
#forecastChart{margin-top:2rem;}
#thresholdNotice{font-weight:700;color:red;margin-top:0.5rem;text-align:center;}
#modelWarning{display:none;padding:1rem;margin-bottom:1rem;border-radius:16px;background:#f59e0b;color:#fff;font-weight:700;text-align:center;}
#alertMap{width:100%;height:400px;border-radius:12px;margin-top:1rem;}
footer{background:var(--green);color:#fff;text-align:center;padding:2rem 1rem;}
.youtube-section iframe{width:100%;max-width:560px;height:315px;margin-bottom:1rem;border:none;border-radius:12px;}
</style>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

<header>
  <img src="https://jace200677.github.io/cdnstatic.playweather/northwoods.png" alt="Northwoods Playschool Logo" />
</header>

<nav>
  <a href="#about">About</a>
  <a href="#weather">Weather</a>
  <a href="#mapSection">Map</a>
  <a href="#youtube">YouTube</a>
  <a href="#contact">Contact</a>
</nav>

<section id="about">
  <h2>About Northwoods Playschool</h2>
  <p>Northwoods Playschool is a warm, nature-inspired learning environment where children grow through exploration, creativity, and play.</p>
</section>

<section id="weather">
  <h2>Weather Safety & Intensity</h2>

  <div id="advisory">‚ö†Ô∏è Severe Weather Active in the United States</div>
  <div id="modelWarning">From 7 PM tonight to 6 PM tomorrow all playschool weather models percent as low as 0 percent. should 100% by 7pm tomorrow after 6pm tomorrow</div>
  <div id="activeLocation"></div>

  <div class="intensity">
    <div>
      <div class="score" id="score">--</div>
      <div class="level" id="level">Loading‚Ä¶</div>
      <small>Composite Weather Score (0‚Äì500)</small><br>
      <small>Dynamic Threshold: <span id="thresholdValue">--</span></small><br>
      <small id="thresholdMessage" style="color:red;font-weight:700;display:none;">‚ö†Ô∏è Threshold Exceeded!</small>
    </div>
    <div>
      <p id="details" style="margin:0;font-size:0.95rem;opacity:0.85;"></p>
    </div>
  </div>

  <div id="youtubeChance">Calculating video/live stream chance‚Ä¶</div>

  <div id="alerts">
    <h3>National Weather Service Alerts (Oregon & Washington)</h3>
    <ul id="alertsList" style="margin:0;padding-left:1.2rem;"></ul>
  </div>

  <div id="forecastChart">
    <h2>Projected Weather Score</h2>
    <canvas id="weatherChart" style="max-width:100%; height:250px"></canvas>
    <p id="thresholdNotice"></p>
  </div>
</section>

<section id="mapSection">
  <h2>Weather Alerts Map</h2>
  <div id="alertMap"></div>
</section>

<section id="youtube">
  <h2>Jace's YouTube Channel</h2>
  <div id="ytLive" class="youtube-section"></div>
</section>

<section id="contact">
  <h2>Contact Us</h2>
  <p>Email: <strong>jacefink17@outlook.com</strong></p>
</section>

<footer>
  <small>¬© 2026 Northwoods Playschool ¬∑ Learning through nature üå≤</small>
</footer>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// ---------------- CONFIG ----------------
const LAT = 44.9778;
const LON = -93.2650;
const NWS_POINTS = `https://api.weather.gov/points/${LAT},${LON}`;
const NWS_ALERTS = "https://api.weather.gov/alerts/active?status=actual";
const API_KEY = "AIzaSyB2E1ZSsDgmOE6kliazjHZMGgpFjxJ0K6s";
const CHANNEL_ID = "hy6rl";
let weatherChart;
let DYNAMIC_THRESHOLD = 0;
window.NATIONAL_ALERT_SCORE = 0;

// ---------------- WEATHER FUNCTIONS ----------------
function calculateLocalIntensity(temp, wind, humidity, precip){
  let score=0;
  if(temp>=90||temp<=32) score+=150;
  else if(temp>=80||temp<=40) score+=75;
  if(wind>=25) score+=125;
  else if(wind>=15) score+=75;
  if(precip>0) score+=100;
  if(humidity>=90||humidity<=20) score+=50;
  return Math.min(score,500);
}
function getLevel(score){
  if(score>=350)return"High";
  if(score>=200)return"Moderate";
  return"Low";
}
function getYouTubeChance(score){
  if(score>=400)return"Yes ‚Äì Perfect for streaming or posting!";
  if(score>=300)return"Probably ‚Äì Good weather for content.";
  if(score>=150)return"Maybe ‚Äì Moderate conditions.";
  return"No / Unlikely ‚Äì Avoid outdoor content.";
}

// ---------------- NWS ALERT THRESHOLD LOGIC ----------------
function alertSeverityWeight(event){
  event = event.toLowerCase();
  if(event.includes("tornado")||event.includes("hurricane")) return 5;
  if(event.includes("blizzard")||event.includes("ice storm")) return 4;
  if(event.includes("severe thunderstorm")) return 3;
  if(event.includes("flood")||event.includes("high wind")) return 2;
  if(event.includes("advisory")) return 1;
  return 0;
}
function timeDecayScore(issueTime){
  const now = new Date();
  const issued = new Date(issueTime);
  const hoursDiff = (now - issued)/1000/3600;
  return Math.max(0, 1 - 0.1*hoursDiff);
}
function populationFactor(pop){
  if(!pop) return 1;
  return Math.log10(pop+1);
}
function combineAlertScores(scores){
  const sumSquares = scores.reduce((acc,s)=>acc+s*s,0);
  return Math.min(Math.sqrt(sumSquares),500);
}

// ---------------- FETCH NWS ALERTS + CUSTOM ----------------
async function updateNWSAlerts(){
  try{
    const data = await fetch(NWS_ALERTS).then(r => r.json());
    let alerts = data.features || [];
    const list = document.getElementById("alertsList");
    list.innerHTML = "";

    const alertScores = [];
    let maxScore = 0;
    let focusAlert = null;
    const now = new Date();

    // ---------------- CUSTOM ALERTS ----------------
    const tomorrow = new Date(); 
    tomorrow.setDate(now.getDate()+1);

    // --- Hurricane Watch: 6 PM today ‚Üí 7 AM tomorrow ---
    const today6pm = new Date(); today6pm.setHours(18,0,0,0);
    const tomorrow7am = new Date(); tomorrow7am.setDate(today6pm.getDate()+1); tomorrow7am.setHours(7,0,0,0);
    if(now >= today6pm && now <= tomorrow7am){
      alerts.push({
        properties:{
          event:"Hurricane Watch",
          areaDesc:"Oregon & Washington",
          sent:today6pm.toISOString(),
          ends:tomorrow7am.toISOString(),
          population:7500000
        }
      });
    }

    // --- Hurricane Warning: 10:05 AM ‚Üí 12:30 PM ---
    const hurricaneStart = new Date(tomorrow); hurricaneStart.setHours(10,5,0,0);
    const hurricaneEnd   = new Date(tomorrow); hurricaneEnd.setHours(12,30,0,0);
    if(now >= hurricaneStart && now <= hurricaneEnd){
      alerts.push({
        properties:{
          event:"Hurricane Warning",
          areaDesc:"Oregon & Washington",
          sent:hurricaneStart.toISOString(),
          ends:hurricaneEnd.toISOString(),
          population:7500000
        }
      });
    }

    // --- Extreme Wind Warning: 12:30 PM ‚Üí 6 PM ---
    const windStart = new Date(tomorrow); windStart.setHours(12,30,0,0);
    const windEnd   = new Date(tomorrow); windEnd.setHours(18,0,0,0);
    if(now >= windStart && now <= windEnd){
      alerts.push({
        properties:{
          event:"Extreme Wind Warning",
          areaDesc:"Oregon & Washington",
          sent:windStart.toISOString(),
          ends:windEnd.toISOString(),
          population:7500000
        }
      });
    }

    // ---------------- FILTER TO OREGON & WASHINGTON ----------------
    alerts = alerts.filter(a=>{
      const area = a.properties.areaDesc.toLowerCase();
      return area.includes("oregon")||area.includes("washington");
    });

    // ---------------- CALCULATE ALERT SCORES ----------------
    alerts.forEach(a=>{
      const severity = alertSeverityWeight(a.properties.event);
      const pop = a.properties.population||1;
      const decay = timeDecayScore(a.properties.sent);
      const score = severity*50*populationFactor(pop)*decay;
      alertScores.push(score);

      // track highest score alert for active location
      if(score>maxScore){maxScore=score;focusAlert=a;}

      // create list item
      const li = document.createElement("li");
      li.textContent = `${a.properties.event} ‚Äî ${a.properties.areaDesc} ‚Äî Score: ${Math.round(score)}`;

      // highlight specific alerts
      if(a.properties.event.includes("Hurricane")) {
        li.style.background="#f59e0b"; // orange
        li.style.color="#fff";
        li.style.padding="0.5rem";
        li.style.borderRadius="8px";
      }
      if(a.properties.event.includes("Extreme Wind")) {
        li.style.background="#b91c1c"; // red
        li.style.color="#fff";
        li.style.padding="0.5rem";
        li.style.borderRadius="8px";
      }

      list.appendChild(li);
    });

    // ---------------- UPDATE GLOBAL SCORES ----------------
    window.NATIONAL_ALERT_SCORE = alerts.length ? combineAlertScores(alertScores) : 0;
    DYNAMIC_THRESHOLD = Math.max(window.NATIONAL_ALERT_SCORE,300);
    document.getElementById("thresholdValue").textContent = Math.round(DYNAMIC_THRESHOLD);

    // ---------------- UPDATE FOCUS ALERT ----------------
    const locationBox = document.getElementById("activeLocation");
    if(focusAlert && maxScore >=200){
      locationBox.style.display="block";
      locationBox.textContent=`Severe Weather Focus: ${focusAlert.properties.event} ‚Äî ${focusAlert.properties.areaDesc}`;
    } else {
      locationBox.style.display="none";
    }

  }catch(err){
    console.error(err);
    window.NATIONAL_ALERT_SCORE = 0;
    DYNAMIC_THRESHOLD = 300;
  }
}


// ---------------- FETCH LOCAL WEATHER ----------------
async function fetchLocalWeather(){
  try{
    const p = await fetch(NWS_POINTS).then(r=>r.json());
    const stations = await fetch(p.properties.observationStations).then(r=>r.json());
    const id = stations.features[0].properties.stationIdentifier;
    const obs = await fetch(`https://api.weather.gov/stations/${id}/observations/latest`).then(r=>r.json());
    const d = obs.properties;
    return {temp:d.temperature.value*9/5+32,wind:d.windSpeed.value*2.23694,humidity:d.relativeHumidity.value,precip:(d.precipitationLastHour.value||0)*0.03937};
  }catch{return {temp:70,wind:0,humidity:50,precip:0};}
}

// ---------------- UPDATE UI ----------------
async function updateWeather(){
  const obs = await fetchLocalWeather();
  await updateNWSAlerts();
  let localScore = calculateLocalIntensity(obs.temp, obs.wind, obs.humidity, obs.precip);
  const nwsScore = window.NATIONAL_ALERT_SCORE;
  let finalScore = Math.min(localScore*0.6+nwsScore*0.4,500);

  const now = new Date();
  const tomorrow10am = new Date(); tomorrow10am.setDate(now.getDate()+1); tomorrow10am.setHours(10,0,0,0);
  const tomorrow10_03am = new Date(); tomorrow10_03am.setDate(now.getDate()+1); tomorrow10_03am.setHours(10,3,0,0);
  if(now >= tomorrow10am && now <= tomorrow10_03am){finalScore=500;}

  const scoreEl = document.getElementById("score");
  const thresholdMsg = document.getElementById("thresholdMessage");
  scoreEl.textContent=Math.round(finalScore);
  if(finalScore>=DYNAMIC_THRESHOLD){scoreEl.classList.add("high");thresholdMsg.style.display="inline";}
  else{scoreEl.classList.remove("high");thresholdMsg.style.display="none";}

  document.getElementById("level").textContent=getLevel(finalScore);
  document.getElementById("details").textContent=`Local: ${obs.temp.toFixed(1)}¬∞F ¬∑ Wind ${obs.wind.toFixed(1)} mph ¬∑ Humidity ${obs.humidity}%`;
  document.getElementById("youtubeChance").textContent="Video / Live Stream Chance: "+getYouTubeChance(finalScore);

  const today7pm = new Date(); today7pm.setHours(19,0,0,0);
  const tomorrow6pm = new Date(); tomorrow6pm.setDate(today7pm.getDate()+1); tomorrow6pm.setHours(18,0,0,0);
  document.getElementById("modelWarning").style.display = (now >= today7pm && now <= tomorrow6pm)?"block":"none";

  generateForecast(finalScore);
  updateMapHighlights(); // update map each weather update
}

// ---------------- FORECAST CHART ----------------
function generateForecast(currentScore){
  const labels=[],obsData=[],projData=[],thresholdLine=[];
  const now = new Date();
  for(let i=-60;i<=30;i++){
    const t = new Date(now.getTime() + i*60000);
    labels.push(`${t.getHours()}:${t.getMinutes().toString().padStart(2,'0')}`);
    if(i<=0) obsData.push(Math.max(currentScore - Math.random()*50,0));
    else projData.push(Math.max(currentScore + (Math.random()*100-50),0));
    thresholdLine.push(DYNAMIC_THRESHOLD);
  }
  const mergedObs = obsData.concat(Array(projData.length-1).fill(null));
  const mergedProj = Array(obsData.length-1).fill(null).concat(projData);

  const ctx = document.getElementById('weatherChart').getContext('2d');
  if(weatherChart) weatherChart.destroy();
  weatherChart = new Chart(ctx,{
    type:'line',
    data:{labels:labels,datasets:[
      {label:'Observed',data:mergedObs,borderColor:'green',fill:false,tension:0.3},
      {label:'Projected',data:mergedProj,borderColor:'orange',fill:true,tension:0.3},
      {label:`Threshold`,data:thresholdLine,borderColor:'red',borderDash:[5,5],fill:false,tension:0.1,pointRadius:0}
    ]},
    options:{scales:{y:{beginAtZero:true,max:500}}}
  });

  const exceeded = projData.some(s=>s>DYNAMIC_THRESHOLD);
  document.getElementById("thresholdNotice").textContent = exceeded?`‚ö†Ô∏è Threshold Exceeded!`:`Forecast within safe range`;
}

// ---------------- YOUTUBE LIVE/UPLOADS ----------------
async function fetchYouTubeLiveOrUploads() {
  try {
    const liveData = await fetch(
      `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${CHANNEL_ID}&eventType=live&type=video&key=${API_KEY}`
    ).then(r => r.json());

    const container = document.getElementById("ytLive");
    container.innerHTML = "";

    if (liveData.items && liveData.items.length > 0) {
      liveData.items.forEach(video => {
        const iframe = document.createElement("iframe");
        iframe.src = `https://www.youtube.com/embed/${video.id.videoId}?autoplay=1`;
        iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
        iframe.allowFullscreen = true;
        container.appendChild(iframe);
      });
    } else {
      const channel = await fetch(
        `https://www.googleapis.com/youtube/v3/channels?part=contentDetails&id=${CHANNEL_ID}&key=${API_KEY}`
      ).then(r => r.json());
      const uploadsId = channel.items[0].contentDetails.relatedPlaylists.uploads;
      const uploads = await fetch(
        `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=5&playlistId=${uploadsId}&key=${API_KEY}`
      ).then(r => r.json());

      uploads.items.forEach(video => {
        const iframe = document.createElement("iframe");
        iframe.src = `https://www.youtube.com/embed/${video.snippet.resourceId.videoId}`;
        iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
        iframe.allowFullscreen = true;
        container.appendChild(iframe);
      });
    }
  } catch (e) {
    console.error(e);
    document.getElementById("ytLive").innerHTML = "<p>Error loading YouTube videos.</p>";
  }
}

// ---------------- MAP ----------------
let map, oregonLayer, washingtonLayer;
function initMap() {
  map = L.map('alertMap').setView([45, -120], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

  oregonLayer = L.polygon([[46.2920, -124.5662],[46.2920, -116.4630],[42.0016, -116.4630],[42.0016, -124.5662]],{color:'transparent',fillOpacity:0.4}).addTo(map);
  washingtonLayer = L.polygon([[49.0024, -124.8489],[49.0024, -116.9169],[45.5435, -116.9169],[45.5435, -124.8489]],{color:'transparent',fillOpacity:0.4}).addTo(map);
}
function updateMapHighlights(){
  const now = new Date();
  oregonLayer.setStyle({fillColor:'transparent'});
  washingtonLayer.setStyle({fillColor:'transparent'});

  const today6pm = new Date(); today6pm.setHours(18,0,0,0);
  const tomorrow7am = new Date(); tomorrow7am.setDate(today6pm.getDate()+1); tomorrow7am.setHours(7,0,0,0);
  
  // Hurricane Watch: 6 PM today ‚Üí 7 AM tomorrow
  if(now >= today6pm && now <= tomorrow7am){
    oregonLayer.setStyle({fillColor:'orange'});
    washingtonLayer.setStyle({fillColor:'orange'});
  }

  const tomorrow = new Date(); tomorrow.setDate(now.getDate()+1);

  // Hurricane Warning: 10:05 AM ‚Üí 12:30 PM
  const hurricaneStart = new Date(tomorrow); hurricaneStart.setHours(10,5,0,0);
  const hurricaneEnd   = new Date(tomorrow); hurricaneEnd.setHours(12,30,0,0);
  if(now >= hurricaneStart && now <= hurricaneEnd){
    oregonLayer.setStyle({fillColor:'orange'});
    washingtonLayer.setStyle({fillColor:'orange'});
  }

  // Extreme Wind Warning: 12:30 PM ‚Üí 6 PM
  const windStart = new Date(tomorrow); windStart.setHours(12,30,0,0);
  const windEnd   = new Date(tomorrow); windEnd.setHours(18,0,0,0);
  if(now >= windStart && now <= windEnd){
    oregonLayer.setStyle({fillColor:'#8B0000'}); // Dark Red
    washingtonLayer.setStyle({fillColor:'#8B0000'});
  }
}

// ---------------- INIT ----------------
initMap();
updateWeather();
fetchYouTubeLiveOrUploads();
setInterval(()=>{ updateWeather(); fetchYouTubeLiveOrUploads(); },300000);
setTimeout(()=>location.reload(),120000);

</script>
</body>
</html>
