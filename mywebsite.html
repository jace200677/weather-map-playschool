<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ---------------- CONFIG ----------------
const LAT = 44.9778;
const LON = -93.2650;
const NWS_POINTS = `https://api.weather.gov/points/${LAT},${LON}`;
const NWS_ALERTS = "https://api.weather.gov/alerts/active?status=actual";
window.NATIONAL_ALERT_SCORE = 0;

// ---------------- WEATHER FUNCTIONS ----------------
function calculateLocalIntensity(temp, wind, humidity, precip){
  let score=0;
  if(temp>=90||temp<=32) score+=150;
  else if(temp>=80||temp<=40) score+=75;
  if(wind>=25) score+=125;
  else if(wind>=15) score+=75;
  if(precip>0) score+=100;
  if(humidity>=90||humidity<=20) score+=50;
  return Math.min(score,500);
}

function calculatePoopIntensity(temp, wind, weatherScore){
  let base=weatherScore*3;
  base+=temp>85?300:0;
  base+=wind>15?200:0;
  base+=Math.random()*400;
  return Math.min(Math.round(base),2026);
}

function poopLevel(score){
  if(score>1600)return"üö® DEFCON GAS";
  if(score>1200)return"üí® Severe Fart Risk";
  if(score>700)return"üò¨ Noticeable";
  if(score>300)return"üôÇ Mild";
  return"üòå All Clear";
}

function getLevel(score){
  if(score>=350)return"High";
  if(score>=200)return"Moderate";
  return"Low";
}

function getYouTubeChance(score){
  if(score>=400)return"Yes ‚Äì Perfect for streaming or posting!";
  if(score>=300)return"Probably ‚Äì Good weather for content.";
  if(score>=150)return"Maybe ‚Äì Moderate conditions.";
  return"No / Unlikely ‚Äì Avoid outdoor content.";
}

// ---------------- LOCAL WEATHER ----------------
async function fetchLocalWeather(){
  try{
    const p=await fetch(NWS_POINTS).then(r=>r.json());
    const stations=await fetch(p.properties.observationStations).then(r=>r.json());
    const id=stations.features[0].properties.stationIdentifier;
    const obs=await fetch(`https://api.weather.gov/stations/${id}/observations/latest`).then(r=>r.json());
    const d=obs.properties;
    return {
      temp:d.temperature.value*9/5+32,
      wind:d.windSpeed.value*2.23694,
      humidity:d.relativeHumidity.value,
      precip:(d.precipitationLastHour.value||0)*0.03937
    };
  }catch{
    return {temp:70, wind:0, humidity:50, precip:0};
  }
}

// ---------------- ALERTS WITH POPULATION ----------------
function getAlertSeverityScore(alert){
  const e = alert.properties.event.toLowerCase();
  let baseScore = 0;
  
  if(e.includes("tornado") || e.includes("hurricane")) baseScore = 500;
  else if(e.includes("blizzard") || e.includes("ice storm")) baseScore = 400;
  else if(e.includes("severe thunderstorm")) baseScore = 300;
  else if(e.includes("flood") || e.includes("high wind")) baseScore = 200;
  else if(e.includes("advisory")) baseScore = 100;

  // Scale by population (if available)
  const pop = alert.properties["population"] || 1; // fallback
  const popFactor = Math.log10(pop + 1);
  return Math.min(baseScore * popFactor, 500);
}

async function updateNWSAlerts(){
  try{
    const data = await fetch(NWS_ALERTS).then(r=>r.json());
    const list = document.getElementById("alertsList");
    const locationBox = document.getElementById("activeLocation");
    list.innerHTML = "";
    locationBox.style.display = "none";
    let maxScore = 0;
    let focusAlert = null;

    if(data.features.length){
      data.features.forEach(a=>{
        const score = getAlertSeverityScore(a);
        if(score > maxScore){ maxScore = score; focusAlert = a; }
        const li = document.createElement("li");
        li.textContent = `${a.properties.event}: ${a.properties.areaDesc}`;
        list.appendChild(li);
      });
    } else {
      list.innerHTML = "<li>No active alerts in the USA.</li>";
    }

    window.NATIONAL_ALERT_SCORE = maxScore;

    if(focusAlert && maxScore >= 200){
      locationBox.style.display = "block";
      locationBox.textContent = `Severe Weather Focus: ${focusAlert.properties.event} ‚Äî ${focusAlert.properties.areaDesc}`;
    }
  }catch{
    window.NATIONAL_ALERT_SCORE = 0;
  }
}

// ---------------- UPDATE WEATHER ----------------
async function updateWeather(){
  const obs = await fetchLocalWeather();
  const localScore = calculateLocalIntensity(obs.temp, obs.wind, obs.humidity, obs.precip);

  // Aggregate NWS alerts
  await updateNWSAlerts();
  const nwsScore = window.NATIONAL_ALERT_SCORE;

  // Combine local + alert score (weighted average)
  const finalScore = Math.min(localScore*0.6 + nwsScore*0.4, 500);

  // Update UI
  document.getElementById("score").textContent = Math.round(finalScore);
  document.getElementById("level").textContent = getLevel(finalScore);
  document.getElementById("details").textContent = `Local: ${obs.temp.toFixed(1)}¬∞F ¬∑ Wind ${obs.wind.toFixed(1)} mph ¬∑ Humidity ${obs.humidity}%`;
  document.getElementById("youtubeChance").textContent = "Video / Live Stream Chance: "+getYouTubeChance(finalScore);

  const poop = calculatePoopIntensity(obs.temp, obs.wind, finalScore);
  document.getElementById("poopScore").textContent = poop;
  document.getElementById("poopLevel").textContent = poopLevel(poop);

  generateForecast(finalScore);
}

// ---------------- FORECAST CHART ----------------
let forecastData=[],observedData=[],weatherChart;
function generateForecast(currentScore){
  observedData=[]; forecastData=[]; let thresholdExceeded=false;
  const now=new Date();

  for(let i=-60;i<=0;i++){
    const obsScore = Math.max(currentScore - Math.round(Math.random()*50), 0);
    observedData.push(obsScore);
  }

  for(let i=0;i<=30;i++){
    const projScore = Math.max(currentScore + Math.round((Math.random()*100)-50), 0);
    forecastData.push(projScore);
    if(projScore>450) thresholdExceeded=true;
  }

  document.getElementById("thresholdNotice").textContent = thresholdExceeded ? "‚ö†Ô∏è Threshold Exceeded in projected forecast!" : "Forecast within safe range.";

  const labels = [];
  for(let i=-60;i<=30;i++){
    const time = new Date(now.getTime() + i*60000);
    let h = time.getHours();
    const m = time.getMinutes().toString().padStart(2,'0');
    const ampm = h>=12?'pm':'am';
    h = h%12; if(h===0) h=12;
    labels.push(`${h}:${m} ${ampm}`);
  }

  const mergedObserved = observedData.concat(Array(forecastData.length-1).fill(null));
  const mergedProjected = Array(observedData.length-1).fill(null).concat(forecastData);

  const ctx = document.getElementById('weatherChart').getContext('2d');
  if(weatherChart) weatherChart.destroy();
  weatherChart = new Chart(ctx,{
    type:'line',
    data:{labels:labels,datasets:[
      {label:'Observed (past 60 min)',data:mergedObserved,borderColor:'rgba(31,77,43,0.9)',backgroundColor:'rgba(31,77,43,0.2)',fill:false,tension:0.3,pointRadius:2,pointBackgroundColor:'rgba(31,77,43,0.9)'},
      {label:'Projected (next 30 min)',data:mergedProjected,borderColor:'rgba(245,157,11,0.9)',backgroundColor:'rgba(245,157,11,0.2)',fill:true,tension:0.3,pointRadius:2}
    ]},
    options:{scales:{y:{beginAtZero:true,max:500},x:{ticks:{maxTicksLimit:20}}}}
  });
}

// ---------------- YOUTUBE LIVE / UPLOADS ----------------
const API_KEY = "AIzaSyB2E1ZSsDgmOE6kliazjHZMGgpFjxJ0K6s"; // replace
const CHANNEL_ID = "UC-hy6rl"; // replace

async function fetchYouTubeLiveOrUploads() {
  try {
    const liveData = await fetch(
      `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${CHANNEL_ID}&eventType=live&type=video&key=${API_KEY}`
    ).then(r => r.json());

    const container = document.getElementById("ytLive");
    container.innerHTML = "";

    if (liveData.items && liveData.items.length > 0) {
      liveData.items.forEach(video => {
        const iframe = document.createElement("iframe");
        iframe.src = `https://www.youtube.com/embed/${video.id.videoId}?autoplay=1`;
        iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
        iframe.allowFullscreen = true;
        container.appendChild(iframe);
      });
    } else {
      const channel = await fetch(
        `https://www.googleapis.com/youtube/v3/channels?part=contentDetails&id=${CHANNEL_ID}&key=${API_KEY}`
      ).then(r => r.json());
      const uploadsId = channel.items[0].contentDetails.relatedPlaylists.uploads;

      const uploads = await fetch(
        `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=5&playlistId=${uploadsId}&key=${API_KEY}`
      ).then(r => r.json());

      uploads.items.forEach(video => {
        const iframe = document.createElement("iframe");
        iframe.src = `https://www.youtube.com/embed/${video.snippet.resourceId.videoId}`;
        iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
        iframe.allowFullscreen = true;
        container.appendChild(iframe);
      });
    }
  } catch (e) {
    console.error(e);
    document.getElementById("ytLive").innerHTML = "<p>Error loading YouTube videos.</p>";
  }
}

// ---------------- INIT ----------------
updateWeather();
fetchYouTubeLiveOrUploads();
setInterval(()=>{ updateWeather(); fetchYouTubeLiveOrUploads(); }, 300000); // every 5 min
setTimeout(()=>location.reload(), 120000); // refresh every 2 min
</script>
